<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Music Basics Game — C/D/E & Clefs</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Music&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --ink: #111827;
      --accent: #ffd54f;
      --ok: #16a34a;
      --bad: #dc2626;
    }
    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); display: grid; place-items: center; padding: 16px; }
    .app { width: min(880px, 100%); background: var(--card); padding: 16px; border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }

    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; flex-wrap: wrap; }
    .title { font-weight: 900; letter-spacing:.2px; }
    .chips { display:flex; gap:8px; }
    .chip { background:#fff; border:2px solid #e5e7eb; padding:8px 12px; border-radius:999px; font-weight:800; }

    svg { width: min(720px, 96vw); height: auto; overflow: visible; display:block; margin: 0 auto; }
    .msg { text-align: center; font-size: 1.2em; font-weight: 700; margin: 10px 0; }
    .choices { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
    button.choice { padding: 12px; border-radius: 10px; border: none; background: var(--ink); color: #fff; cursor: pointer; font-weight: bold; font-size: 1em; }
    button.correct { background: var(--ok); }
    button.wrong { background: var(--bad); }
    .controls { display: flex; gap: 10px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }
    .controls button { border: none; padding: 10px 14px; border-radius: 8px; font-weight: bold; background: var(--accent); cursor: pointer; }

    /* Fun animations */
    @keyframes pop { 0% { transform: scale(1); opacity:1; } 60% { transform: scale(1.12); } 100% { transform: scale(1); opacity:1; } }
    @keyframes shake { 0%,100% { transform: translateX(0); } 20% { transform: translateX(-6px); } 40% { transform: translateX(6px); } 60% { transform: translateX(-4px); } 80% { transform: translateX(4px); } }
    .shake { animation: shake .35s ease; }
    .pop { animation: pop .35s ease; }
    .tests { display:none; margin-top:8px; font-size:12px; opacity:.8; text-align:center; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">🎵 Music Basics Game — C/D/E & Clefs</div>
      <div class="chips">
        <div class="chip" id="scoreChip">Score: 0</div>
        <div class="chip" id="streakChip">Streak: 0</div>
      </div>
    </header>

    <div id="card"></div>
    <div id="msg" class="msg"></div>
    <div class="choices" id="choices"></div>
    <div class="controls">
      <button id="newRound">New Round</button>
      <button id="toggleHard">Toggle Hard Mode</button>
    </div>
    <div id="testResults" class="tests"></div>
  </div>

  <script type="module">
    // ---------- Helpers ----------
    const rnd = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const TESTING = location.hash.includes('test');

    // ---------- Sounds (Web Audio) ----------
    const audio = new (window.AudioContext || window.webkitAudioContext)();
    function beep(freq=880, duration=0.12, type='sine', gain=0.06) {
      const o = audio.createOscillator();
      const g = audio.createGain();
      o.type = type; o.frequency.value = freq; g.gain.value = gain;
      o.connect(g).connect(audio.destination);
      o.start(); o.stop(audio.currentTime + duration);
    }
    function chordSuccess(){ // sparkle for clefs
      beep(660, .10, 'triangle');
      setTimeout(()=>beep(880, .10, 'triangle'), 110);
      setTimeout(()=>beep(1046.5, .12, 'triangle'), 220);
    }
    function buzzFail(){
      beep(200, .18, 'square', 0.05);
      setTimeout(()=>beep(160, .18, 'square', 0.05), 140);
    }

    // Actual pitch playback for notes — one octave ABOVE (C5/D5/E5) and longer
    const NOTE_FREQ_4 = { C4: 261.63, D4: 293.66, E4: 329.63 };
    function playNoteId(id, duration=1.2){
      try { audio.resume && audio.resume(); } catch {}
      const base = NOTE_FREQ_4[id];
      if (!base) { chordSuccess(); return; }
      const freq = base * 2; // one octave higher
      const osc = audio.createOscillator();
      const gain = audio.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq;
      const now = audio.currentTime;
      gain.gain.setValueAtTime(0.00001, now);
      gain.gain.exponentialRampToValueAtTime(0.08, now + 0.03);
      gain.gain.exponentialRampToValueAtTime(0.00001, now + duration);
      osc.connect(gain).connect(audio.destination);
      osc.start(now);
      osc.stop(now + duration + 0.02);
    }

    // ---------- SVG Card (compact layout) ----------
    let currentSVG = null;
    function staffSVG({note=null, clef=null}) {
      const W = 720, H = 380, M = 36; // compact canvas
      const staffTop = H/2 - 80;
      const staffGap = 24;
      const VB_PAD = 40;
      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `${-VB_PAD} ${-VB_PAD} ${W + VB_PAD*2} ${H + VB_PAD*2}`);

      const bg = document.createElementNS(svgNS, 'rect');
      bg.setAttribute('width', W); bg.setAttribute('height', H); bg.setAttribute('fill', '#fff');
      svg.appendChild(bg);

      const stripe = document.createElementNS(svgNS, 'rect');
      stripe.setAttribute('x', W-30); stripe.setAttribute('width', 30); stripe.setAttribute('height', H); stripe.setAttribute('fill', '#ffd54f');
      svg.appendChild(stripe);

      // Staff lines
      for (let i=0;i<5;i++){
        const line = document.createElementNS(svgNS, 'line');
        line.setAttribute('x1', M); line.setAttribute('x2', W - 60);
        line.setAttribute('y1', staffTop + i*staffGap); line.setAttribute('y2', staffTop + i*staffGap);
        line.setAttribute('stroke', '#111827'); line.setAttribute('stroke-width', 4);
        svg.appendChild(line);
      }

      // Clefs
      if (clef === 'treble' || (!clef && note)) {
        const text = document.createElementNS(svgNS, 'text');
        text.textContent = '\uD834\uDD1E';
        text.setAttribute('x', M + 34);
        text.setAttribute('y', staffTop + staffGap*3 + 24);
        text.setAttribute('font-size', 160);
        text.setAttribute('font-family', '"Noto Music", system-ui');
        svg.appendChild(text);
      }
      if (clef === 'bass') {
        const text = document.createElementNS(svgNS, 'text');
        text.textContent = '\uD834\uDD22';
        text.setAttribute('x', W/2 - 40);
        text.setAttribute('y', H/2 + 40);
        text.setAttribute('font-size', 180);
        text.setAttribute('font-family', '"Noto Music", system-ui');
        svg.appendChild(text);
        return svg;
      }

      // Notes (treble context visually)
      if (note) {
        const x = W/2 + 120;
        const yPositions = { 'E4': staffTop + 4*staffGap, 'D4': staffTop + 4.5*staffGap, 'C4': staffTop + 5*staffGap };
        const y = yPositions[note];
        if (note === 'C4') {
          const ledger = document.createElementNS(svgNS, 'line');
          ledger.setAttribute('x1', x - 40); ledger.setAttribute('x2', x + 40);
          ledger.setAttribute('y1', staffTop + 5*staffGap); ledger.setAttribute('y2', staffTop + 5*staffGap);
          ledger.setAttribute('stroke', '#111827'); ledger.setAttribute('stroke-width', 4);
          svg.appendChild(ledger);
        }
        const notehead = document.createElementNS(svgNS, 'ellipse');
        notehead.setAttribute('cx', x); notehead.setAttribute('cy', y);
        notehead.setAttribute('rx', 18); notehead.setAttribute('ry', 14);
        notehead.setAttribute('fill', '#111827');
        notehead.setAttribute('transform', `rotate(-20 ${x} ${y})`);
        svg.appendChild(notehead);
        const stem = document.createElementNS(svgNS, 'line');
        stem.setAttribute('x1', x + 16); stem.setAttribute('x2', x + 16);
        stem.setAttribute('y1', y); stem.setAttribute('y2', y - 80);
        stem.setAttribute('stroke', '#111827'); stem.setAttribute('stroke-width', 4);
        svg.appendChild(stem);
      }

      return svg;
    }

    // ---------- Celebration Effects ----------
    function explodeConfetti(svg) {
      const svgNS = 'http://www.w3.org/2000/svg';
      const g = document.createElementNS(svgNS, 'g');
      svg.appendChild(g);
      const colors = ['#16a34a','#22c55e','#84cc16','#eab308','#f97316'];
      const cx = 480, cy = 220; // near the note
      for (let i=0;i<18;i++){
        const c = document.createElementNS(svgNS, 'circle');
        c.setAttribute('cx', cx);
        c.setAttribute('cy', cy);
        c.setAttribute('r', 6);
        c.setAttribute('fill', colors[rnd(0,colors.length-1)]);
        g.appendChild(c);
        const angle = Math.random()*Math.PI*2;
        const dist = 50 + Math.random()*80;
        const tx = Math.cos(angle)*dist;
        const ty = Math.sin(angle)*dist;
        c.animate([
          { transform: 'translate(0px,0px)', opacity: 1 },
          { transform: `translate(${tx}px,${ty}px)`, opacity: 0 }
        ], { duration: 700, easing: 'ease-out' });
      }
      setTimeout(()=>g.remove(), 750);
    }

    // ---------- Game Data ----------
    const CARDS = [
      { id: 'C4', kind: 'note', label: 'C (Middle C)' },
      { id: 'D4', kind: 'note', label: 'D' },
      { id: 'E4', kind: 'note', label: 'E' },
      { id: 'treble', kind: 'clef', label: 'Treble Clef' },
      { id: 'bass', kind: 'clef', label: 'Bass Clef' },
    ];
    const CHOICES = [
      { id: 'C4', text: 'C' },
      { id: 'D4', text: 'D' },
      { id: 'E4', text: 'E' },
      { id: 'treble', text: 'Treble Clef' },
      { id: 'bass', text: 'Bass Clef' },
    ];

    // ---------- State & Elements ----------
    let scoreCount = 0, streakCount = 0, hardMode = false, currentCard = null;

    const els = {
      card: document.getElementById('card'),
      choices: document.getElementById('choices'),
      msg: document.getElementById('msg'),
      newRound: document.getElementById('newRound'),
      toggleHard: document.getElementById('toggleHard'),
      scoreChip: document.getElementById('scoreChip'),
      streakChip: document.getElementById('streakChip'),
      testResults: document.getElementById('testResults')
    };

    function updateHUD(){
      els.scoreChip.textContent = `Score: ${scoreCount}`;
      els.streakChip.textContent = `Streak: ${streakCount}`;
    }

    function renderCard(item) {
      els.card.innerHTML = '';
      currentSVG = (item.kind === 'note') ? staffSVG({ note: item.id, clef: 'treble' }) : staffSVG({ note: null, clef: item.id });
      els.card.appendChild(currentSVG);
    }

    function setMsg(text, good=false, bad=false) {
      els.msg.textContent = text;
      els.msg.style.color = good ? 'var(--ok)' : bad ? 'var(--bad)' : 'inherit';
      els.msg.classList.remove('pop');
      void els.msg.offsetWidth; // reflow to restart animation
      els.msg.classList.add('pop');
    }

    function newQuestion() {
      currentCard = CARDS[rnd(0, CARDS.length-1)];
      renderCard(currentCard);
      setMsg('What is this?');
      renderChoices();
    }

    function renderChoices() {
      els.choices.innerHTML = '';
      CHOICES.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'choice';
        btn.textContent = c.text;
        btn.onclick = () => onGuess(c.id, btn);
        els.choices.appendChild(btn);
      });
    }

    function onGuess(id, btn) {
      if (!currentCard) return;
      if (id === currentCard.id) {
        scoreCount += 10; streakCount += 1; updateHUD();
        setMsg('🎉 Correct!', true);
        btn.classList.add('correct');
        if (currentCard.kind === 'note') { playNoteId(currentCard.id, 1.2); } else { chordSuccess(); }
        if (currentSVG) explodeConfetti(currentSVG);
        if (!TESTING) setTimeout(newQuestion, 800);
      } else {
        streakCount = 0; scoreCount = Math.max(0, scoreCount - 2); updateHUD();
        setMsg('Oops — try again!', false, true);
        btn.classList.add('wrong');
        buzzFail();
        if (currentSVG) {
          currentSVG.classList.remove('shake');
          void currentSVG.offsetWidth; // restart animation
          currentSVG.classList.add('shake');
        }
        if (hardMode) btn.disabled = true;
      }
    }

    els.newRound.onclick = () => { scoreCount = 0; streakCount = 0; updateHUD(); newQuestion(); };
    els.toggleHard.onclick = () => { hardMode = !hardMode; els.toggleHard.textContent = hardMode ? 'Hard Mode: ON' : 'Toggle Hard Mode'; };

    // ---------- Self-tests (only in #test mode) ----------
    function runSelfTests(){
      const out = [];
      const ok = (name, cond) => out.push(`${cond ? '✅' : '❌'} ${name}`);

      // Test A: staff draws 5 lines
      const svg = staffSVG({ note: null, clef: 'treble' });
      ok('Staff has 5 lines', svg.querySelectorAll('line').length >= 5);

      // Test B: treble clef glyph exists
      ok('Treble clef glyph present', /\uD834\uDD1E/.test(svg.textContent));

      // Test C: C4 renders ledger line
      const svgC = staffSVG({ note: 'C4', clef: 'treble' });
      ok('C4 ledger line exists', svgC.querySelectorAll('line').length >= 6);

      // Test D: playNoteId does not throw for C4 (octave up)
      try { playNoteId('C4', 0.2); ok('playNoteId(C4) executes', true); } catch(e) { ok('playNoteId(C4) executes', false); }

      // Test E: correct guess updates score & streak
      scoreCount = 0; streakCount = 0; currentCard = { id: 'D4', kind: 'note' };
      const btn = document.createElement('button');
      onGuess('D4', btn);
      ok('Correct adds 10', scoreCount === 10);
      ok('Streak increments', streakCount === 1);

      els.testResults.textContent = out.join('  •  ');
      els.testResults.style.display = 'block';
      console.log('\nSelf-tests:\n' + out.join('\n'));
    }

    updateHUD();
    if (!TESTING) {
      newQuestion();
    } else {
      runSelfTests();
    }
  </script>
</body>
</html>
